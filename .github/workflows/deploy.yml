name: Deploy AI Landing Zone
on:
  workflow_dispatch:
 
jobs:
  terraform:
    runs-on: ubuntu-latest
    timeout-minutes: 180

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2

      - name: Install Az PowerShell Module
        shell: pwsh
        run: |
          Install-Module -Name Az -Force -Scope CurrentUser -Repository PSGallery
          Import-Module Az

      - name: Azure Login using Service Principal
        shell: pwsh
        env:
          ARM_CLIENT_ID: ${{ secrets.ARM_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.ARM_CLIENT_SECRET }}
          ARM_TENANT_ID: ${{ secrets.ARM_TENANT_ID }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.ARM_SUBSCRIPTION_ID }}
        run: |
          $clientId = $env:ARM_CLIENT_ID
          $clientSecret = $env:ARM_CLIENT_SECRET
          $tenantId = $env:ARM_TENANT_ID
          $subscriptionId = $env:ARM_SUBSCRIPTION_ID
          Connect-AzAccount -ServicePrincipal -Tenant $tenantId -Credential (New-Object System.Management.Automation.PSCredential($clientId, (ConvertTo-SecureString $clientSecret -AsPlainText -Force)))
          Set-AzContext -SubscriptionId $subscriptionId
       
      - name: Terraform Init and Apply
        run: |
          terraform init
          terraform apply -auto-approve
        env:
          ARM_CLIENT_ID: ${{ secrets.ARM_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.ARM_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.ARM_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.ARM_TENANT_ID }}
